@page "/"
@using System.Net.Http
@using System.Threading.Tasks
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<h1>Hello, world!</h1>
<button class="btn btn-primary" @onclick="GetXML">
    Get XML
</button>
<div style="width: 100%">
    <div @ref="@blocklyDiv"
         style="display: inline-block; height: 480px; width: 58%"></div>
    <textarea @ref="@output" disabled="disabled"
              style="display: inline-block; height: 480px; width: 38%;">
@XMLText
    </textarea>
</div>

<xml xmlns="https://developers.google.com/blockly/xml" @ref="@toolbox" style="display: none">
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
        <block type="controls_repeat_ext">
            <value name="TIMES">
                <block type="math_number">
                    <field name="NUM">10</field>
                </block>
            </value>
        </block>
        <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
        <block type="math_number">
            <field name="NUM">123</field>
        </block>
        <block type="math_arithmetic"></block>
        <block type="math_single"></block>
    </category>
    <category name="Text" colour="%{BKY_TEXTS_HUE}">
        <block type="text"></block>
        <block type="text_length"></block>
        <block type="text_print"></block>
        <block type="text_prompt_ext">
            <value name="TEXT">
                <block type="text"></block>
            </value>
        </block>
    </category>
    <sep></sep>
    <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}">
    </category>
    <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
    </category>
</xml>

<xml xmlns="https://developers.google.com/blockly/xml" @ref="@startBlocks" style="display: none">
    <block type="variables_set" id="set_n_initial" inline="true" x="20" y="20">
        <field name="VAR">n</field>
        <value name="VALUE">
            <block type="math_number">
                <field name="NUM">1</field>
            </block>
        </value>
        <next>
            <block type="controls_repeat_ext" id="repeat" inline="true">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">4</field>
                    </block>
                </value>
                <statement name="DO">
                    <block type="wait_seconds" id="wait">
                        <field name="SECONDS">1.0</field>
                        <next>
                            <block type="variables_set" id="set_n_update" inline="true">
                                <field name="VAR">n</field>
                                <value name="VALUE">
                                    <block type="math_arithmetic" inline="true">
                                        <field name="OP">MULTIPLY</field>
                                        <value name="A">
                                            <block type="variables_get">
                                                <field name="VAR">n</field>
                                            </block>
                                        </value>
                                        <value name="B">
                                            <block type="math_number">
                                                <field name="NUM">2</field>
                                            </block>
                                        </value>
                                    </block>
                                </value>
                                <next>
                                    <block type="text_print" id="print" inline="false">
                                        <value name="TEXT">
                                            <block type="variables_get">
                                                <field name="VAR">n</field>
                                            </block>
                                        </value>
                                    </block>
                                </next>
                            </block>
                        </next>
                    </block>
                </statement>
            </block>
        </next>
    </block>
</xml>

@code {
    private ElementReference blocklyDiv;
    private ElementReference output;
    private ElementReference toolbox;
    private ElementReference startBlocks;
    string XMLText = "";
    protected override async Task
        OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Interop.DemoWorkspace(
                JSRuntime,
                blocklyDiv,
                toolbox,
                startBlocks
                );
        }
    }

    private async Task GetXML()
    {
        XMLText = await Interop.GetXML(JSRuntime);
    }
}